name: Build and Push Docker Image to ECR + GitOps Sync

permissions:
  contents: write   # needed to push to gitops branch

on:
  push:
    branches: [ main ]   # CI runs when app code changes in main

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # ðŸ§± Step 1: Checkout source code
      - name: Checkout source
        uses: actions/checkout@v4

      # ðŸ§­ Step 2: Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      # ðŸ”‘ Step 3: Login to Amazon ECR
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ðŸ³ Step 4: Build, tag, and push image to ECR
      - name: Build and push image
        id: build-image
        env:
          ECR_REPO_URI: ${{ secrets.ECR_REPO_URI }}
        run: |
          IMAGE_TAG=${GITHUB_SHA::7}
          echo "Building image with tag: $IMAGE_TAG"

          # Build and tag
          docker build -t $ECR_REPO_URI:$IMAGE_TAG -t $ECR_REPO_URI:latest ./app

          # Push both tags
          docker push $ECR_REPO_URI:$IMAGE_TAG
          docker push $ECR_REPO_URI:latest

          # Export tag for later steps
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

      # ðŸš€ Step 5: Update Helm chart in GitOps branch
      - name: Update GitOps branch Helm values
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"

          echo "Cloning GitOps branch..."
          git clone https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }} --branch gitops gitops
          cd gitops

          echo "Updating image tag in helm/hello-world/values.yaml..."
          sed -i "s|tag:.*|tag: ${{ steps.build-image.outputs.image_tag }}|" helm/hello-world/values.yaml

          git add helm/hello-world/values.yaml
          git commit -m "Update image tag to ${{ steps.build-image.outputs.image_tag }}"
          git push origin gitops

      # âœ… Step 6: Confirm success
      - name: Workflow complete
        run: echo "âœ… Docker image pushed to ECR and GitOps branch updated successfully!"
